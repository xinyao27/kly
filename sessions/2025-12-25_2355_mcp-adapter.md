# Session: MCP Adapter Implementation

> Date: 2025-12-25 23:55
> Duration: ~1h

## Summary

Implemented complete MCP (Model Context Protocol) adapter for kly, enabling kly apps to be exposed as MCP servers for Claude Desktop/Code integration. Single-app architecture with automatic schema conversion and zero-config setup.

## What We Did

### Core Implementation

1. **Schema Converter** (`src/mcp/schema-converter.ts`)
   - Converts StandardSchema (Zod) to JSON Schema for MCP
   - Uses Zod 4's native `z.toJSONSchema()` function
   - Preserves descriptions, types, defaults, and validations
   - Fallback for non-Zod schemas

2. **MCP Server** (`src/mcp/server.ts`)
   - Built on `@modelcontextprotocol/sdk` v1.25.1
   - Implements stdio transport for Claude Desktop/Code
   - Handles `initialize`, `tools/list`, and `tools/call` requests
   - Formats tool results (string, JSON, or undefined)
   - Proper error handling with MCP error format

3. **CLI Integration** (`bin/kly.ts`)
   - Added `kly mcp <target>` subcommand
   - Works with local files and remote GitHub repos
   - Sets `KLY_MCP_MODE=true` environment variable
   - Updated help text with MCP examples

4. **Runtime Mode Detection** (`src/define-app.ts`)
   - Auto-starts MCP server when in MCP mode
   - Dynamic import of MCP module (tree-shakeable)
   - Maintains support for CLI and programmatic modes

5. **Remote Support** (`src/remote/`)
   - Extended `RunRemoteOptions` with `mcp?: boolean`
   - Sets MCP mode for remote repos
   - Enables: `kly mcp user/repo[@ref]`

### Dependencies Added

- `@modelcontextprotocol/sdk` v1.25.1 - Official MCP TypeScript SDK
- Removed `zod-to-json-schema` (using Zod 4 native support)

### Testing

Created test client (`test-mcp.ts`) that verified:

- ✅ Initialize request/response
- ✅ Tools list with proper JSON Schema
- ✅ Tool execution with arguments
- ✅ Result formatting (text content)

Test with `examples/hello.ts`:

```json
{
  "tools": [{
    "name": "greet",
    "description": "Say hello to someone",
    "inputSchema": {
      "type": "object",
      "properties": {
        "name": { "description": "Name to greet", "type": "string" },
        "excited": { "description": "Add exclamation mark", "default": false, "type": "boolean" }
      },
      "required": ["name", "excited"],
      "additionalProperties": false
    }
  }]
}
```

## Current State

MCP adapter is fully functional:

```bash
# Local files
kly mcp ./my-app.ts

# Remote repos
kly mcp user/repo
kly mcp user/repo@v1.0.0
kly mcp user/repo@branch

# With cache refresh
kly mcp user/repo --force
```

### Claude Desktop Configuration

```json
{
  "mcpServers": {
    "kly-hello": {
      "command": "kly",
      "args": ["mcp", "./examples/hello.ts"]
    },
    "kly-weather": {
      "command": "kly",
      "args": ["mcp", "user/weather-app"]
    }
  }
}
```

## Architecture Decisions

### Single App Mode (Chosen)

Each kly app runs as its own MCP server. Simple, isolated, easy to configure.

**Pros:**

- Simple configuration
- Isolated processes
- Clear ownership
- No registry complexity

**Cons:**

- One config entry per app
- More processes for many apps

### Multi-App Registry (Deferred)

One MCP server exposes multiple apps from a directory/registry.

**Pros:**

- Single config entry
- Centralized management

**Cons:**

- More complex
- Shared state
- Harder to debug

### Schema Conversion Approach

**Zod 4 Native (Chosen):**

```typescript
import * as z from "zod";
z.toJSONSchema(schema, { target: "draft-07", io: "output" })
```

**External Library (Rejected):**

- ~~`zod-to-json-schema`~~ - Unnecessary with Zod 4

## Key Files Created/Modified

### New Files

- `src/mcp/server.ts` - MCP server implementation (139 lines)
- `src/mcp/schema-converter.ts` - Schema conversion (51 lines)
- `src/mcp/index.ts` - Public exports
- `MCP.md` - Full MCP adapter documentation
- `examples/mcp-test.md` - Testing guide

### Modified Files

- `bin/kly.ts` - Added `mcp` subcommand, `runFileAsMcp()`
- `src/define-app.ts` - Auto-start MCP server in MCP mode
- `src/index.ts` - Export `startMcpServer`, `JsonSchema`
- `src/remote/index.ts` - Pass `mcp` flag to `executeApp()`
- `src/remote/types.ts` - Added `mcp?: boolean` to options
- `package.json` - Added `@modelcontextprotocol/sdk` dependency

## Documentation

Created comprehensive docs:

1. **MCP.md** - Architecture, usage, examples, protocol flow
2. **examples/mcp-test.md** - Step-by-step testing guide with Claude Desktop

## Next Steps

From the previous session's roadmap:

- [x] Implement MCP adapter (Claude Desktop/Code integration) ✅
- [ ] Write README documentation
- [ ] Implement `ctx.infer` for AI parameter parsing
- [ ] Add permission system (Phase 2)
- [ ] Prepare v0.1.0 release

### Future MCP Enhancements

- [ ] Support Valibot and ArkType schemas
- [ ] Multi-app registry mode (if needed)
- [ ] HTTP/SSE transport support
- [ ] MCP resources (files, templates)
- [ ] MCP prompts (interaction templates)
- [ ] Streaming responses
- [ ] Authentication/authorization

## Technical Notes

### Zod 4 JSON Schema

- `z.toJSONSchema()` is a function, not a method
- Options: `target`, `unrepresentable`, `cycles`, `reused`, `io`
- `io: "output"` extracts output type (after transforms)
- `unrepresentable: "any"` handles unsupported types gracefully

### MCP Protocol (2025-11-25)

- JSON-RPC 2.0 over stdio
- Stateful connection with initialization
- Capability negotiation (server advertises `tools: {}`)
- Dynamic tool discovery via `tools/list`
- Tool execution via `tools/call`
- Notifications for tool list changes

### Stdio Transport Gotcha

**CRITICAL:** Never `console.log()` in MCP mode - corrupts JSON-RPC!

- Stdout = JSON-RPC protocol only
- Stderr = logging/debugging
- Use SDK's built-in logger if needed

## Lessons Learned

1. **Zod 4 Native Support**: Saved a dependency by using `z.toJSONSchema()`
2. **Single App Mode**: Simpler is better for v1, can add registry later
3. **Dynamic Imports**: Keep MCP code out of CLI builds for smaller bundles
4. **Mode Detection**: Environment variables cleanly separate runtimes
5. **Testing First**: Test client helped catch schema conversion bug early

## Follow-up: MCP Mode UI Fixes

After initial implementation, discovered and fixed issue with interactive UI in MCP mode.

### Problem

Tools using `input()`, `select()`, `form()` etc. in their execute functions would fail in MCP mode with:

```
Interactive input not available in non-TTY mode. Please provide all required arguments.
```

### Root Cause

- MCP uses stdio for JSON-RPC protocol (non-TTY)
- Interactive UI functions check `isTTY()` and fail
- In MCP mode, all parameters should come from inputSchema, not interactive prompts

### Solution

Updated all interactive UI functions to detect MCP mode and provide clear error messages:

1. **`input()`** - Throws error mentioning inputSchema
2. **`password()`** - Suggests environment variables
3. **`form()`** - Lists missing required fields
4. **`select()`** - Points to enum in schema
5. **`confirm()`** - Warns and uses default value

### Updated Files

- `src/ui/components/input.ts` - MCP mode error
- `src/ui/components/password.ts` - MCP mode error
- `src/ui/components/form.ts` - MCP mode error with field list
- `src/ui/components/select.ts` - MCP mode error
- `src/ui/components/confirm.ts` - MCP mode warning

### Documentation Created

- **MCP-BEST-PRACTICES.md** - Comprehensive guide on writing MCP-compatible tools
  - DO: Define all inputs in inputSchema
  - DON'T: Use interactive UI in execute
  - Safe vs unsafe UI functions
  - Common errors and solutions

## Build Output

```
dist/
├── bin/kly.mjs (11.79 KB)
├── index.mjs (21.95 KB) - +1KB for MCP UI checks
├── mcp-*.mjs (3.10 KB) - Dynamically loaded in MCP mode
└── *.d.mts (type definitions)
```

Total: ~100 KB (MCP code is code-split)
